function Protobuf(n){this.buf=n;this.pos=0}function VectorTile(n,t){var r,u,i;for(this.layers={},this._buffer=n,t=t||n.length;n.pos<t;)r=n.readVarint(),u=r>>3,u==3?(i=this.readLayer(),i.length&&(this.layers[i.name]=i)):n.skip(r)}function VectorTileFeature(n,t,i,r,u){var e,f,o,s,h,c;for(this.properties={},this.extent=i,this.type=0,this._buffer=n,this._geometry=-1,t=t||n.length;n.pos<t;)if(e=n.readVarint(),f=e>>3,f==1)this._id=n.readVarint();else if(f==2)for(o=n.readVarint(),s=n.pos+o;n.pos<s;)h=r[n.readVarint()],c=u[n.readVarint()],this.properties[h]=c;else f==3?this.type=n.readVarint():f==4?(this._geometry=n.pos,n.skip(e)):n.skip(e)}function VectorTileLayer(n,t){this.version=1;this.name=null;this.extent=4096;this.length=0;this._buffer=n;this._keys=[];this._values=[];this._features=[];var r,i;for(t=t||n.length;n.pos<t;)r=n.readVarint(),i=r>>3,i===15?this.version=n.readVarint():i===1?this.name=n.readString():i===5?this.extent=n.readVarint():i===2?(this.length++,this._features.push(n.pos),n.skip(r)):i===3?this._keys.push(n.readString()):i===4?this._values.push(this.readFeatureValue()):n.skip(r)}function Point(n,t){this.x=n;this.y=t}function MVTFeature(n,t,i,r,u){var f,e;if(!t)return null;for(f in t)this[f]=t[f];this.mvtLayer=n;this.mvtSource=n.mvtSource;this.map=n.mvtSource.map;this.id=r;this.layerLink=this.mvtSource.layerLink;this.toggleEnabled=!0;this.selected=!1;this.divisor=t.extent/i.tileSize;this.extent=t.extent;this.tileSize=i.tileSize;this.tiles={};this.style=u;this.addTileFeature(t,i);e=this;this.map.on("zoomend",function(){e.staticLabel=null});u&&u.dynamicLabel&&typeof u.dynamicLabel=="function"&&(this.dynamicLabel=this.mvtSource.dynamicLabel.createFeature(this));ajax(e)}function ajax(n){var t=n.style,i;return t&&t.ajaxSource&&typeof t.ajaxSource=="function"&&(i=t.ajaxSource(n),i&&Util.getJSON(i,function(t,i){if(t)throw["ajaxSource AJAX Error",t];else return ajaxCallback(n,i),!0})),!1}function ajaxCallback(n,t){n.ajaxData=t;typeof n.ajaxDataReceived=="function"&&n.ajaxDataReceived(n,t);n._setStyle(n.mvtLayer.style);redrawTiles(n)}function redrawTiles(n){var u=n.tiles,f=n.mvtLayer,t,i,r;for(t in u)i=parseInt(t.split(":")[0]),r=n.map.getZoom(),i===r&&f.redrawTile(t)}function removeLabels(n){for(var r,i=n.featuresWithLabels,t=0,u=i.length;t<u;t++)r=i[t],r.removeLabel();n.featuresWithLabels=[]}function in_circle(n,t,i,r,u){var f=Math.pow(n-r,2)+Math.pow(t-u,2);return f<=Math.pow(i,2)}function waitFor(n,t,i){var e=i?i:3e3,u=(new Date).getTime(),r=typeof n=="string"?eval(n):n(),f=setInterval(function(){(new Date).getTime()-u<e&&!r?r=typeof n=="string"?eval(n):n():r?(console.log("'waitFor()' finished in "+((new Date).getTime()-u)+"ms."),clearInterval(f),typeof t=="string"?eval(t):t("success")):(console.log("'waitFor()' timeout"),clearInterval(f),typeof t=="string"?eval(t):t("timeout"))},50)}function getTileURL(n,t,i){var r=parseInt(Math.floor((t+180)/360*(1<<i))),u=parseInt(Math.floor((1-Math.log(Math.tan(n.toRad())+1/Math.cos(n.toRad()))/Math.PI)/2*(1<<i)));return""+i+":"+r+":"+u}function tileLoaded(n,t){n.loadedTiles[t.id]=t}function parseVT(n){var t,i;for(t in n.layers)i=n.layers[t],parseVTFeatures(i);return n}function parseVTFeatures(n){var r,t,u,i;for(n.parsedFeatures=[],r=n._features,t=0,u=r.length;t<u;t++)i=n.feature(t),i.coordinates=i.loadGeometry(),n.parsedFeatures.push(i);return n}function Util(){}function StaticLabel(n,t,i,r){var f=this,u;this.mvtFeature=n;this.map=n.map;this.zoom=t.zoom;this.latLng=i;this.selected=!1;n.linkedFeature&&(u=n.linkedFeature(),u&&u.selected&&(f.selected=!0));init(f,n,t,i,r)}function init(n,t,i,r,u){var e=t.ajaxData,f=n.style=u.staticLabel(t,e),o=n.icon=L.divIcon({className:f.cssClass||"label-icon-text",html:f.html,iconSize:f.iconSize||[50,50]});n.marker=L.marker(r,{icon:o}).addTo(n.map);n.selected&&n.marker._icon.classList.add(n.style.cssSelectedClass||"label-icon-text-selected");n.marker.on("click",function(){n.toggle()});n.map.on("zoomend",function(t){var i=t.target.getZoom();n.zoom!==i&&n.map.removeLayer(n.marker)})}Protobuf.prototype={get length(){return this.buf.length}};Protobuf.Varint=0;Protobuf.Int64=1;Protobuf.Message=2;Protobuf.String=2;Protobuf.Packed=2;Protobuf.Int32=5;Protobuf.prototype.destroy=function(){this.buf=null};Protobuf.prototype.readUInt32=function(){var n=this.buf.readUInt32LE(this.pos);return this.pos+=4,n};Protobuf.prototype.readUInt64=function(){var n=this.buf.readUInt64LE(this.pos);return this.pos+=8,n};Protobuf.prototype.readDouble=function(){var n=ieee754.read(this.buf,this.pos,!0,52,8);return this.pos+=8,n};Protobuf.prototype.readVarint=function(){var n=this.pos;return this.buf[n]<=127?(this.pos++,this.buf[n]):this.buf[n+1]<=127?(this.pos+=2,this.buf[n]&127|this.buf[n+1]<<7):this.buf[n+2]<=127?(this.pos+=3,this.buf[n]&127|(this.buf[n+1]&127)<<7|this.buf[n+2]<<14):this.buf[n+3]<=127?(this.pos+=4,this.buf[n]&127|(this.buf[n+1]&127)<<7|(this.buf[n+2]&127)<<14|this.buf[n+3]<<21):this.buf[n+4]<=127?(this.pos+=5,(this.buf[n]&127|(this.buf[n+1]&127)<<7|(this.buf[n+2]&127)<<14|this.buf[n+3]<<21)+this.buf[n+4]*268435456):(this.skip(Protobuf.Varint),0)};Protobuf.prototype.readSVarint=function(){var n=this.readVarint();if(n>2147483647)throw new Error("TODO: Handle numbers >= 2^30");return n>>1^-(n&1)};Protobuf.prototype.readString=function(){for(var u=this.readVarint(),r=String.fromCharCode,t=this.buf,n=this.pos,f=this.pos+u,i="";n<f;)if(t[n]<=127)i+=r(t[n++]);else if(t[n]<=191)throw new Error("Invalid UTF-8 codepoint: "+t[n]);else if(t[n]<=223)i+=r((t[n++]&31)<<6|t[n++]&63);else if(t[n]<=239)i+=r((t[n++]&31)<<12|(t[n++]&63)<<6|t[n++]&63);else if(t[n]<=247)n+=4;else if(t[n]<=251)n+=5;else if(t[n]<=253)n+=6;else throw new Error("Invalid UTF-8 codepoint: "+t[n]);return this.pos+=u,i};Protobuf.prototype.readBuffer=function(){var n=this.readVarint(),t=this.buf.subarray(this.pos,this.pos+n);return this.pos+=n,t};Protobuf.prototype.readPacked=function(n){for(var i=this.readVarint(),r=this.pos+i,t=[];this.pos<r;)t.push(this["read"+n]());return t};Protobuf.prototype.skip=function(n){var t=n&7,i;switch(t){case Protobuf.Varint:while(this.buf[this.pos++]>127);break;case Protobuf.Int64:this.pos+=8;break;case Protobuf.Message:i=this.readVarint();this.pos+=i;break;case Protobuf.Int32:this.pos+=4;break;default:throw new Error("Unimplemented type: "+t);}};Protobuf.prototype.writeTag=function(n,t){this.writeVarint(n<<3|t)};Protobuf.prototype.realloc=function(n){for(var t=this.buf.length,i;t<this.pos+n;)t*=2;t!=this.buf.length&&(i=new Buffer(t),this.buf.copy(i),this.buf=i)};Protobuf.prototype.finish=function(){return this.buf.slice(0,this.pos)};Protobuf.prototype.writePacked=function(n,t,i){var u,r,f;if(i.length){for(u=new Protobuf,r=0;r<i.length;r++)u["write"+n](i[r]);f=u.finish();this.writeTag(t,Protobuf.Packed);this.writeBuffer(f)}};Protobuf.prototype.writeUInt32=function(n){this.realloc(4);this.buf.writeUInt32LE(n,this.pos);this.pos+=4};Protobuf.prototype.writeTaggedUInt32=function(n,t){this.writeTag(n,Protobuf.Int32);this.writeUInt32(t)};Protobuf.prototype.writeVarint=function(n){if(n=Number(n),isNaN(n)&&(n=0),n<=127)this.realloc(1),this.buf[this.pos++]=n;else if(n<=16383)this.realloc(2),this.buf[this.pos++]=128|n>>>0&127,this.buf[this.pos++]=0|n>>>7&127;else if(n<=33554431)this.realloc(3),this.buf[this.pos++]=128|n>>>0&127,this.buf[this.pos++]=128|n>>>7&127,this.buf[this.pos++]=0|n>>>14&127;else if(n<=268435455)this.realloc(4),this.buf[this.pos++]=128|n>>>0&127,this.buf[this.pos++]=128|n>>>7&127,this.buf[this.pos++]=128|n>>>14&127,this.buf[this.pos++]=0|n>>>21&127;else while(n>0){var t=n&127;n=Math.floor(n/128);n>0&&(t|=128);this.realloc(1);this.buf[this.pos++]=t}};Protobuf.prototype.writeTaggedVarint=function(n,t){this.writeTag(n,Protobuf.Varint);this.writeVarint(t)};Protobuf.prototype.writeSVarint=function(n){n>=0?this.writeVarint(n*2):this.writeVarint(n*-2-1)};Protobuf.prototype.writeTaggedSVarint=function(n,t){this.writeTag(n,Protobuf.Varint);this.writeSVarint(t)};Protobuf.prototype.writeBoolean=function(n){this.writeVarint(Boolean(n))};Protobuf.prototype.writeTaggedBoolean=function(n,t){this.writeTaggedVarint(n,Boolean(t))};Protobuf.prototype.writeString=function(n){n=String(n);var t=Buffer.byteLength(n);this.writeVarint(t);this.realloc(t);this.buf.write(n,this.pos);this.pos+=t};Protobuf.prototype.writeTaggedString=function(n,t){this.writeTag(n,Protobuf.String);this.writeString(t)};Protobuf.prototype.writeFloat=function(n){this.realloc(4);this.buf.writeFloatLE(n,this.pos);this.pos+=4};Protobuf.prototype.writeTaggedFloat=function(n,t){this.writeTag(n,Protobuf.Int32);this.writeFloat(t)};Protobuf.prototype.writeDouble=function(n){this.realloc(8);this.buf.writeDoubleLE(n,this.pos);this.pos+=8};Protobuf.prototype.writeTaggedDouble=function(n,t){this.writeTag(n,Protobuf.Int64);this.writeDouble(t)};Protobuf.prototype.writeBuffer=function(n){var t=n.length;this.writeVarint(t);this.realloc(t);n.copy(this.buf,this.pos);this.pos+=t};Protobuf.prototype.writeTaggedBuffer=function(n,t){this.writeTag(n,Protobuf.String);this.writeBuffer(t)};Protobuf.prototype.writeMessage=function(n,t){var i=t.finish();this.writeTag(n,Protobuf.Message);this.writeBuffer(i)};VectorTile.prototype.readLayer=function(){var n=this._buffer,i=n.readVarint(),t=n.pos+i,r=new VectorTileLayer(n,t);return n.pos=t,r};VectorTileFeature.types=["Unknown","Point","LineString","Polygon"];VectorTileFeature.prototype.loadGeometry=function(){var t=this._buffer,f;t.pos=this._geometry;for(var s=t.readVarint(),h=t.pos+s,i=1,r=0,e=0,o=0,u=[],n;t.pos<h;)if(r||(f=t.readVarint(),i=f&7,r=f>>3),r--,i===1||i===2)e+=t.readSVarint(),o+=t.readSVarint(),i===1&&(n&&u.push(n),n=[]),n.push(new Point(e,o));else if(i===7)n.push(n[0].clone());else throw new Error("unknown command "+i);return n&&u.push(n),u};VectorTileFeature.prototype.bbox=function(){var n=this._buffer,h;n.pos=this._geometry;for(var c=n.readVarint(),l=n.pos+c,t=1,u=0,i=0,r=0,f=Infinity,e=-Infinity,o=Infinity,s=-Infinity;n.pos<l;)if(u||(h=n.readVarint(),t=h&7,u=h>>3),u--,t===1||t===2)i+=n.readSVarint(),r+=n.readSVarint(),i<f&&(f=i),i>e&&(e=i),r<o&&(o=r),r>s&&(s=r);else if(t!==7)throw new Error("unknown command "+t);return[f,o,e,s]};VectorTileLayer.prototype.readFeatureValue=function(){for(var n=this._buffer,i=null,u=n.readVarint(),f=n.pos+u,r,t;n.pos<f;)if(r=n.readVarint(),t=r>>3,t==1)i=n.readString();else if(t==2)throw new Error("read float");else if(t==3)i=n.readDouble();else if(t==4)i=n.readVarint();else if(t==5)throw new Error("read uint");else t==6?i=n.readSVarint():t==7?i=Boolean(n.readVarint()):n.skip(r);return i};VectorTileLayer.prototype.feature=function(n){if(n<0||n>=this._features.length)throw new Error("feature index out of bounds");this._buffer.pos=this._features[n];var t=this._buffer.readVarint()+this._buffer.pos;return new VectorTileFeature(this._buffer,t,this.extent,this._keys,this._values)};Point.prototype={clone:function(){return new Point(this.x,this.y)},add:function(n){return this.clone()._add(n)},sub:function(n){return this.clone()._sub(n)},mult:function(n){return this.clone()._mult(n)},div:function(n){return this.clone()._div(n)},rotate:function(n){return this.clone()._rotate(n)},matMult:function(n){return this.clone()._matMult(n)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(n){return this.x===n.x&&this.y===n.y},dist:function(n){return Math.sqrt(this.distSqr(n))},distSqr:function(n){var t=n.x-this.x,i=n.y-this.y;return t*t+i*i},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(n){return Math.atan2(this.y-n.y,this.x-n.x)},angleWith:function(n){return this.angleWithSep(n.x,n.y)},angleWithSep:function(n,t){return Math.atan2(this.x*t-this.y*n,this.x*n+this.y*t)},_matMult:function(n){var t=n[0]*this.x+n[1]*this.y,i=n[2]*this.x+n[3]*this.y;return this.x=t,this.y=i,this},_add:function(n){return this.x+=n.x,this.y+=n.y,this},_sub:function(n){return this.x-=n.x,this.y-=n.y,this},_mult:function(n){return this.x*=n,this.y*=n,this},_div:function(n){return this.x/=n,this.y/=n,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var n=this.y;return this.y=this.x,this.x=-n,this},_rotate:function(n){var t=Math.cos(n),i=Math.sin(n),r=t*this.x-i*this.y,u=i*this.x+t*this.y;return this.x=r,this.y=u,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}};Point.convert=function(n){return n instanceof Point?n:Array.isArray(n)?new Point(n[0],n[1]):n};MVTFeature.prototype._setStyle=function(n){this.style=n(this,this.ajaxData);this.removeLabel()};MVTFeature.prototype.setStyle=function(n){this.ajaxData=null;this.style=n(this,null);var t=ajax(this);t||this.removeLabel()};MVTFeature.prototype.draw=function(n){var u=this.tiles[n],t=u.vtf,i=u.ctx,f=n.split(":").slice(1,3).join(":"),r;i.canvas=this.mvtLayer._tiles[f];r=this.selected?this.style.selected||this.style:this.style;switch(t.type){case 1:if(this._drawPoint(i,t.coordinates,r),!this.staticLabel&&typeof this.style.staticLabel=="function"){if(this.style.ajaxSource&&!this.ajaxData)break;this._drawStaticLabel(i,t.coordinates,r)}break;case 2:this._drawLineString(i,t.coordinates,r);break;case 3:this._drawPolygon(i,t.coordinates,r);break;default:throw new Error("Unmanaged type: "+t.type);}};MVTFeature.prototype.getPathsForTile=function(n){return this.tiles[n].paths};MVTFeature.prototype.addTileFeature=function(n,t){var i=this.map.getZoom();t.zoom==i&&(this.clearTileFeatures(i),this.tiles[t.id]={ctx:t,vtf:n,paths:[]})};MVTFeature.prototype.clearTileFeatures=function(n){for(var t in this.tiles)t.split(":")[0]!=n&&delete this.tiles[t]};MVTFeature.prototype.toggle=function(){this.selected?this.deselect():this.select()};MVTFeature.prototype.select=function(){this.selected=!0;this.mvtSource.featureSelected(this);redrawTiles(this);var n=this.linkedFeature();n&&n.staticLabel&&!n.staticLabel.selected&&n.staticLabel.select()};MVTFeature.prototype.deselect=function(){this.selected=!1;this.mvtSource.featureDeselected(this);redrawTiles(this);var n=this.linkedFeature();n&&n.staticLabel&&n.staticLabel.selected&&n.staticLabel.deselect()};MVTFeature.prototype.on=function(n,t){this._eventHandlers[n]=t};MVTFeature.prototype._drawPoint=function(n,t,i){var e,f,u,o,r;if(i&&n&&n.canvas){e=this.tiles[n.id];f=1;f=typeof i.radius=="function"?i.radius(n.zoom):i.radius;u=this._tilePoint(t[0][0]);o=n.canvas;try{r=o.getContext("2d")}catch(s){console.log("_drawPoint error: "+s);return}r.beginPath();r.fillStyle=i.color;r.arc(u.x,u.y,f,0,Math.PI*2);r.closePath();r.fill();i.lineWidth&&i.strokeStyle&&(r.lineWidth=i.lineWidth,r.strokeStyle=i.strokeStyle,r.stroke());r.restore();e.paths.push([u])}};MVTFeature.prototype._drawLineString=function(n,t,r){var u,e,s,h,o,c,f;if(r&&n&&n.canvas){u=n.canvas.getContext("2d");u.strokeStyle=r.color;u.lineWidth=r.size;u.beginPath();e=[];s=this.tiles[n.id];for(h in t)for(o=t[h],i=0;i<o.length;i++)c=(i===0?"move":"line")+"To",f=this._tilePoint(o[i]),e.push(f),u[c](f.x,f.y);u.stroke();u.restore();s.paths.push(e)}};MVTFeature.prototype._drawPolygon=function(n,t,i){var r,f,e,l,o,u;if(i&&n&&n.canvas){r=n.canvas.getContext("2d");f=i.outline;r.fillStyle=typeof i.color=="function"?i.color(r):i.color;f&&(r.strokeStyle=f.color,r.lineWidth=f.size);r.beginPath();var h=[],a=this.tiles[n.id],c=this.dynamicLabel;for(c&&c.addTilePolys(n,t),e=0,l=t.length;e<l;e++)for(o=t[e],u=0;u<o.length;u++){var y=o[u],v=(u===0?"move":"line")+"To",s=this._tilePoint(o[u]);h.push(s);r[v](s.x,s.y)}r.closePath();r.fill();f&&r.stroke();a.paths.push(h)}};MVTFeature.prototype._drawStaticLabel=function(n,t,i){if(i&&n&&this.mvtLayer._map){var u=this._tilePoint(t[0][0]),r=this._project(u,n.tile.x,n.tile.y,this.extent,this.tileSize),f=L.point(r.x,r.y),e=this.map.unproject(f);this.staticLabel=new StaticLabel(this,n,e,i);this.mvtLayer.featureWithLabelAdded(this)}};MVTFeature.prototype.removeLabel=function(){this.staticLabel&&(this.staticLabel.remove(),this.staticLabel=null)};MVTFeature.prototype._project=function(n,t,i,r,u){var f=t*u,e=i*u;return{x:Math.floor(n.x+f),y:Math.floor(n.y+e)}};MVTFeature.prototype._tilePoint=function(n){return new L.Point(n.x/this.divisor,n.y/this.divisor)};MVTFeature.prototype.linkedFeature=function(){var n=this.mvtLayer.linkedLayer();return n?n.features[this.id]:null};var MVTLayer=L.TileLayer.Canvas.extend({options:{debug:!1,isHiddenLayer:!1,getIDForLayerFeature:function(){},tileSize:256,lineClickTolerance:2},_featureIsClicked:{},_isPointInPoly:function(n,t){if(t&&t.length){for(var u=!1,i=-1,f=t.length,r=f-1;++i<f;r=i)(t[i].y<=n.y&&n.y<t[r].y||t[r].y<=n.y&&n.y<t[i].y)&&n.x<(t[r].x-t[i].x)*(n.y-t[i].y)/(t[r].y-t[i].y)+t[i].x&&(u=!u);return u}},_getDistanceFromLine:function(n,t){var r=Number.POSITIVE_INFINITY,i,f,u;if(t&&t.length>1)for(n=L.point(n.x,n.y),i=0,f=t.length-1;i<f;i++)u=this._projectPointOnLineSegment(n,t[i],t[i+1]),u.distance<=r&&(r=u.distance);return r},_projectPointOnLineSegment:function(n,t,i){var f=t.distanceTo(i),r,u;return f<1?{distance:n.distanceTo(t),coordinate:t}:(r=((n.x-t.x)*(i.x-t.x)+(n.y-t.y)*(i.y-t.y))/Math.pow(f,2),r<1e-7)?{distance:n.distanceTo(t),coordinate:t}:r>.9999999?{distance:n.distanceTo(i),coordinate:i}:(u=L.point(t.x+r*(i.x-t.x),t.y+r*(i.y-t.y)),{distance:n.distanceTo(u),point:u})},initialize:function(n,t){var i=this;i.mvtSource=n;L.Util.setOptions(this,t);this.style=t.style;this.name=t.name;this._canvasIDToFeatures={};this.features={};this.featuresWithLabels=[];this._highestCount=0},onAdd:function(n){var t=this;t.map=n;L.TileLayer.Canvas.prototype.onAdd.call(this,n);n.on("layerremove",function(n){n.layer._leaflet_id===t._leaflet_id&&removeLabels(t)})},drawTile:function(n,t,i){var r={canvas:n,tile:t,zoom:i,tileSize:this.options.tileSize};r.id=Util.getContextID(r);this._canvasIDToFeatures[r.id]||this._initializeFeaturesHash(r);this.features||(this.features={})},_initializeFeaturesHash:function(n){this._canvasIDToFeatures[n.id]={};this._canvasIDToFeatures[n.id].features=[];this._canvasIDToFeatures[n.id].canvas=n.canvas},_draw:function(){},getCanvas:function(n){var t=n.tile,i=this._tiles[t.x+":"+t.y],r;if(i){n.canvas=i;this.redrawTile(n.id);return}r=this;waitFor(function(){return i=r._tiles[t.x+":"+t.y],i?!0:void 0},function(){i=r._tiles[t.x+":"+t.y];n.canvas=i;r.redrawTile(n.id)},2e3)},parseVectorTileLayer:function(n,t){var i=this,a=t.tile,r={canvas:null,id:t.id,tile:t.tile,zoom:t.zoom,tileSize:t.tileSize},h,f,v,u,c,y,o,s;for(r.canvas=i._tiles[a.x+":"+a.y],this._canvasIDToFeatures[r.id]?this.clearTileFeatureHash(r.id):this._initializeFeaturesHash(r),h=n.parsedFeatures,f=0,v=h.length;f<v;f++)if(u=h[f],u.layer=n,c=i.options.filter,typeof c!="function"||c(u,r)!==!1){y=typeof i.options.getIDForLayerFeature=="function"?i.options.getIDForLayerFeature:Util.getIDForLayerFeature;var l=i.options.getIDForLayerFeature(u)||f,e=i.features[l],s=i.options.layerOrdering;typeof s=="function"&&s(u,r);e?e.addTileFeature(u,r):(o=i.style(u),i.features[l]=e=new MVTFeature(i,u,r,l,o),o&&o.dynamicLabel&&typeof o.dynamicLabel=="function"&&i.featuresWithLabels.push(e));r&&r.id&&i._canvasIDToFeatures[r.id].features.push(e)}s=i.options.layerOrdering;s&&(i._canvasIDToFeatures[r.id].features=i._canvasIDToFeatures[r.id].features.sort(function(n,t){return-(t.properties.zIndex-n.properties.zIndex)}));i.redrawTile(r.id)},setStyle:function(n){var i,r,t,u;this._highestCount=0;this._lowestCount=null;this.style=n;for(t in this.features)i=this.features[t],i.setStyle(n);r=this.map.getZoom();for(t in this._tiles)u=r+":"+t,this.redrawTile(u)},setHighestCount:function(n){n>this._highestCount&&(this._highestCount=n)},getHighestCount:function(){return this._highestCount},setLowestCount:function(n){(!this._lowestCount||n<this._lowestCount)&&(this._lowestCount=n)},getLowestCount:function(){return this._lowestCount},setCountRange:function(n){this.setHighestCount(n);this.setLowestCount(n)},handleClickEvent:function(n,t){var w=n.tileID.split(":").slice(1,3).join(":"),b=n.tileID.split(":")[0],h=this._tiles[w],s,i,c,o,p;if(!h){t(n);return}var l=n.layerPoint.x-h._leaflet_pos.x,a=n.layerPoint.y-h._leaflet_pos.y,v={x:l,y:a},y=this._canvasIDToFeatures[n.tileID].features,e=Number.POSITIVE_INFINITY,f=null,r,u,o;for(s=0;s<y.length;s++){i=y[s];switch(i.type){case 1:for(c=3,c=typeof i.style.radius=="function"?i.style.radius(b):i.style.radius,u=i.getPathsForTile(n.tileID),r=0;r<u.length;r++)in_circle(u[r][0].x,u[r][0].y,c,l,a)&&(f=i,e=0);break;case 2:for(u=i.getPathsForTile(n.tileID),r=0;r<u.length;r++)i.style&&(o=this._getDistanceFromLine(v,u[r]),p=i.selected&&i.style.selected?i.style.selected.size:i.style.size,o<p/2+this.options.lineClickTolerance&&o<e&&(f=i,e=o));break;case 3:for(u=i.getPathsForTile(n.tileID),r=0;r<u.length;r++)this._isPointInPoly(v,u[r])&&(f=i,e=0)}if(e==0)break}f&&f.toggleEnabled&&f.toggle();n.feature=f;t(n)},clearTile:function(n){var i=n.split(":"),r=i[1]+":"+i[2],t,u;if(typeof this._tiles[r]=="undefined"){console.error("typeof this._tiles[canvasId] === 'undefined'");return}t=this._tiles[r];u=t.getContext("2d");u.clearRect(0,0,t.width,t.height)},clearTileFeatureHash:function(n){this._canvasIDToFeatures[n]={features:[]}},clearLayerFeatureHash:function(){this.features={}},redrawTile:function(n){var f,e,t,i,r,u,o,s;if(this.clearTile(n),f=this._canvasIDToFeatures[n],f){for(e=f.features,t=[],i=0;i<e.length;i++)r=e[i],r.selected?t.push(r):r.draw(n);for(u=0,o=t.length;u<o;u++)s=t[u],s.draw(n)}},_resetCanvasIDToFeatures:function(n,t){this._canvasIDToFeatures[n]={};this._canvasIDToFeatures[n].features=[];this._canvasIDToFeatures[n].canvas=t},linkedLayer:function(){if(this.mvtSource.layerLink){var n=this.mvtSource.layerLink(this.name);return this.mvtSource.layers[n]}return null},featureWithLabelAdded:function(n){this.featuresWithLabels.push(n)}});L.TileLayer.MVTSource=L.TileLayer.Canvas.extend({options:{debug:!1,url:"",getIDForLayerFeature:function(){},tileSize:256,visibleLayers:[],xhrHeaders:{}},layers:{},processedTiles:{},_eventHandlers:{},_triggerOnTilesLoadedEvent:!0,_url:"",style:function(n){var t={},i=n.type;switch(i){case 1:t.color="rgba(49,79,79,1)";t.radius=5;t.selected={color:"rgba(255,255,0,0.5)",radius:6};break;case 2:t.color="rgba(161,217,155,0.8)";t.size=3;t.selected={color:"rgba(255,25,0,0.5)",size:4};break;case 3:t.color="rgba(49,79,79,1)";t.outline={color:"rgba(161,217,155,0.8)",size:1};t.selected={color:"rgba(255,140,0,0.3)",outline:{color:"rgba(255,140,0,1)",size:2}}}return t},initialize:function(n){L.Util.setOptions(this,n);this.layers={};this.activeTiles={};this.loadedTiles={};this._url=this.options.url;this.zIndex=n.zIndex;typeof n.style=="function"&&(this.style=n.style);typeof n.ajaxSource=="function"&&(this.ajaxSource=n.ajaxSource);this.layerLink=n.layerLink;this._eventHandlers={};this._tilesToProcess=0},redraw:function(n){n===!1&&(this._triggerOnTilesLoadedEvent=!1);L.TileLayer.Canvas.prototype.redraw.call(this)},onAdd:function(n){var t=this,i;t.map=n;L.TileLayer.Canvas.prototype.onAdd.call(this,n);i=function(n){t._onClick(n)};n.on("click",i);n.on("layerremove",function(r){r.layer._leaflet_id===t._leaflet_id&&r.layer.removeChildLayers&&(r.layer.removeChildLayers(n),n.off("click",i))});t.addChildLayers(n);typeof DynamicLabel=="function"&&(this.dynamicLabel=new DynamicLabel(n,this,{}))},drawTile:function(n,t,i){var r={id:[i,t.x,t.y].join(":"),canvas:n,tile:t,zoom:i,tileSize:this.options.tileSize},u;this._tilesToProcess<this._tilesToLoad&&(this._tilesToProcess=this._tilesToLoad);u=r.id=Util.getContextID(r);this.activeTiles[u]=r;this.processedTiles[r.zoom]||(this.processedTiles[r.zoom]={});this.options.debug&&this._drawDebugInfo(r);this._draw(r)},setOpacity:function(n){this._setVisibleLayersStyle("opacity",n)},setZIndex:function(n){this._setVisibleLayersStyle("zIndex",n)},_setVisibleLayersStyle:function(n,t){for(var i in this.layers)this.layers[i]._tileContainer.style[n]=t},_drawDebugInfo:function(n){var t=this.options.tileSize,i=n.canvas.getContext("2d");i.strokeStyle="#000000";i.fillStyle="#FFFF00";i.strokeRect(0,0,t,t);i.font="12px Arial";i.fillRect(0,0,5,5);i.fillRect(0,t-5,5,5);i.fillRect(t-5,0,5,5);i.fillRect(t-5,t-5,5,5);i.fillRect(t/2-5,t/2-5,10,10);i.strokeText(n.zoom+" "+n.tile.x+" "+n.tile.y,t/2-30,t/2-10)},_draw:function(n){var i=this,f,t,r,u;if(this._url){f=this.getTileUrl({x:n.tile.x,y:n.tile.y,z:n.zoom});t=new XMLHttpRequest;t.onload=function(){if(t.status=="200"){if(!t.response)return;var r=new Uint8Array(t.response),u=new Protobuf(r),f=new VectorTile(u);if(i.map&&i.map.getZoom()!=n.zoom){console.log("Fetched tile for zoom level "+n.zoom+". Map is at zoom level "+i._map.getZoom());return}i.checkVectorTileLayers(parseVT(f),n);tileLoaded(i,n)}i.reduceTilesToProcessCount()};t.onerror=function(){console.log("xhr error: "+t.status)};t.open("GET",f,!0);r=i.options.xhrHeaders;for(u in r)t.setRequestHeader(u,r[u]);t.responseType="arraybuffer";t.send()}},reduceTilesToProcessCount:function(){this._tilesToProcess--;this._tilesToProcess||(this._eventHandlers.PBFLoad&&this._eventHandlers.PBFLoad(),this._pbfLoaded())},checkVectorTileLayers:function(n,t,i){var r=this,u,f,e;if(r.options.visibleLayers&&r.options.visibleLayers.length>0)for(u=0;u<r.options.visibleLayers.length;u++)f=r.options.visibleLayers[u],n.layers[f]&&r.prepareMVTLayers(n.layers[f],f,t,i);else for(e in n.layers)r.prepareMVTLayers(n.layers[e],e,t,i)},prepareMVTLayers:function(n,t,i,r){var u=this;u.layers[t]||(u.layers[t]=u.createMVTLayer(t,n.parsedFeatures[0].type||null));r?u.layers[t].getCanvas(i,n):u.layers[t].parseVectorTileLayer(n,i)},createMVTLayer:function(n){var t=this,r,i;return r=typeof t.options.getIDForLayerFeature=="function"?t.options.getIDForLayerFeature:Util.getIDForLayerFeature,i={getIDForLayerFeature:r,filter:t.options.filter,layerOrdering:t.options.layerOrdering,style:t.style,name:n,asynch:!0},t.options.zIndex&&(i.zIndex=t.zIndex),new MVTLayer(t,i).addTo(t.map)},getLayers:function(){return this.layers},hideLayer:function(n){this.layers[n]&&(this._map.removeLayer(this.layers[n]),this.options.visibleLayers.indexOf("id")>-1&&this.visibleLayers.splice(this.options.visibleLayers.indexOf("id"),1))},showLayer:function(n){this.layers[n]&&(this._map.addLayer(this.layers[n]),this.options.visibleLayers.indexOf("id")==-1&&this.visibleLayers.push(n));this.bringToFront()},removeChildLayers:function(n){var t,i;for(t in this.layers)i=this.layers[t],n.removeLayer(i)},addChildLayers:function(n){var r=this,i,u,f,t;if(r.options.visibleLayers.length>0)for(i=0;i<r.options.visibleLayers.length;i++)u=r.options.visibleLayers[i],t=this.layers[u],t&&n.addLayer(t);else for(f in this.layers)t=this.layers[f],t._map||n.addLayer(t)},bind:function(n,t){this._eventHandlers[n]=t},_onClick:function(n){var i=this,r=i.options.onClick,t=i.options.clickableLayers,s=i.layers,u,e,o,f;if(n.tileID=getTileURL(n.latlng.lat,n.latlng.lng,this.map.getZoom()),t||(t=Object.keys(i.layers)),t&&t.length>0)for(u=0,e=t.length;u<e;u++)o=t[u],f=s[o],f&&f.handleClickEvent(n,function(n){typeof r=="function"&&r(n)});else typeof r=="function"&&r(n)},setFilter:function(n,t){var r,i;for(r in this.layers)i=this.layers[r],t?r.toLowerCase()==t.toLowerCase()&&(i.options.filter=n,i.clearLayerFeatureHash()):(i.options.filter=n,i.clearLayerFeatureHash())},setStyle:function(n,t){var i,r;for(i in this.layers)r=this.layers[i],t?i.toLowerCase()==t.toLowerCase()&&r.setStyle(n):r.setStyle(n)},featureSelected:function(n){if(this.options.mutexToggle&&(this._selectedFeature&&this._selectedFeature.deselect(),this._selectedFeature=n),this.options.onSelect)this.options.onSelect(n)},featureDeselected:function(n){if(this.options.mutexToggle&&this._selectedFeature&&(this._selectedFeature=null),this.options.onDeselect)this.options.onDeselect(n)},_pbfLoaded:function(){this.bringToFront();var t=this,n=t.options.onTilesLoaded;n&&typeof n=="function"&&this._triggerOnTilesLoadedEvent===!0&&n(this);t._triggerOnTilesLoadedEvent=!0}});typeof Number.prototype.toRad=="undefined"&&(Number.prototype.toRad=function(){return this*Math.PI/180});Util.getContextID=function(n){return[n.zoom,n.tile.x,n.tile.y].join(":")};Util.getIDForLayerFeature=function(n){return n.properties.id};Util.getJSON=function(n,t){var i=typeof XMLHttpRequest!="undefined"?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");i.onreadystatechange=function(){var n=i.status,r;i.readyState===4&&n>=200&&n<300?(r=JSON.parse(i.responseText),t(null,r)):t({error:!0,status:n})};i.open("GET",n,!0);i.send()};StaticLabel.prototype.toggle=function(){this.selected?this.deselect():this.select()};StaticLabel.prototype.select=function(){this.selected=!0;this.marker._icon.classList.add(this.style.cssSelectedClass||"label-icon-text-selected");var n=this.mvtFeature.linkedFeature();n.selected||n.select()};StaticLabel.prototype.deselect=function(){this.selected=!1;this.marker._icon.classList.remove(this.style.cssSelectedClass||"label-icon-text-selected");var n=this.mvtFeature.linkedFeature();n.selected&&n.deselect()};StaticLabel.prototype.remove=function(){this.map&&this.marker&&this.map.removeLayer(this.marker)};